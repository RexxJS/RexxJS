<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>REXX Web REPL</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .code { background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .loading { background: #fff3cd; border: 1px solid #ffeaa7; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        select { padding: 8px 12px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        select:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .repl-container { 
            background: #1e1e1e; 
            color: #d4d4d4; 
            font-family: 'Courier New', monospace; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px 0; 
            min-height: 400px; 
            max-height: 600px; 
            overflow-y: auto; 
        }
        
        .repl-history { 
            margin-bottom: 10px; 
            user-select: text; /* Allow text selection in history */
        }
        
        .repl-welcome { 
            color: #6a9955; 
            margin: 2px 0; 
        }
        
        .repl-input-line { 
            display: flex; 
            align-items: center; 
            margin-top: 5px; 
        }
        
        .repl-prompt { 
            color: #4ec9b0; 
            font-weight: bold; 
            margin-right: 8px; 
            user-select: none; 
        }
        
        .repl-input { 
            background: transparent; 
            border: none; 
            color: #d4d4d4; 
            font-family: inherit; 
            font-size: inherit; 
            outline: none; 
            flex: 1; 
            caret-color: #d4d4d4; 
        }
        
        .repl-command { 
            color: #4fc3f7; 
            background: rgba(79, 195, 247, 0.1);
            margin: 8px 0 4px 0; 
            padding: 6px 12px;
            border-left: 4px solid #4fc3f7;
            font-weight: bold;
            user-select: text; 
        }
        
        .repl-output { 
            color: #ce9178; 
            margin: 2px 0 8px 20px; 
            white-space: pre-wrap; 
            user-select: text; 
        }
        
        .repl-error { 
            color: #f48771; 
            margin: 2px 0 8px 20px; 
            white-space: pre-wrap; 
            user-select: text; 
        }
        
        .repl-graphics {
            margin: 10px 0 10px 20px;
        }
        
        .repl-graphics canvas {
            border: 1px solid #555;
            border-radius: 4px;
            background: white;
            display: block;
        }
        
        .repl-graphics .graphics-info {
            color: #4ec9b0;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>REXX Web REPL</h1>
    
    <p>This interactive REXX REPL (Read-Eval-Print Loop) lets you execute REXX code directly in your browser using the REXX Web Loader.</p>
    
    <h2>REXX REPL</h2>
    
    <div id="status" class="status loading">Click "Load REXX" to start</div>
    
    <button onclick="loadRexx()">Load REXX Interpreter</button>
    <div style="display: inline-block; margin: 5px;">
        <select id="demo-select" disabled>
            <option value="">Choose Demo...</option>
            <option value="basic">Basic REXX Features</option>
            <option value="require">Library Loading (REQUIRE)</option>
            <option value="histogram">R Histogram Visualization</option>
        </select>
        <button onclick="runSelectedDemo()" id="run-demo-btn" disabled>Run Demo</button>
        <button onclick="showSelectedDemo()" id="show-demo-btn" disabled>Show Code</button>
    </div>
    <button onclick="clearOutput()">Clear Output</button>
    
    <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="auto-render-checkbox" checked style="margin-right: 8px;">
                <span>Auto-render graphics</span>
            </label>
            <button onclick="manualRender()" id="manual-render-btn" disabled style="padding: 4px 12px; font-size: 0.9em;">
                üìä Render Last Plot
            </button>
        </div>
        <small style="color: #666;">Automatically display charts when created, or use manual render button</small>
    </div>
    
    <div class="repl-container">
        <div id="repl-history" class="repl-history">
            <div class="repl-welcome">Click "Load REXX Interpreter" to begin...</div>
        </div>
        <div class="repl-input-line" id="repl-input-container" style="display: none;">
            <span class="repl-prompt">rexx> </span>
            <input type="text" id="repl-input" class="repl-input" autocomplete="off" spellcheck="false">
        </div>
    </div>
    
    <!-- REXX_LOADER_SECTION_START -->
    <!-- This section will be replaced for bundled version by GitHub Actions -->
    <script src="../interpreter-web-loader.js"></script>
    <!-- REXX_LOADER_SECTION_END -->
    
    <script>
        const statusDiv = document.getElementById('status');
        const demoSelect = document.getElementById('demo-select');
        const runDemoBtn = document.getElementById('run-demo-btn');
        const showDemoBtn = document.getElementById('show-demo-btn');
        const replHistory = document.getElementById('repl-history');
        const replInputContainer = document.getElementById('repl-input-container');
        const replInput = document.getElementById('repl-input');
        
        let interpreter = null;
        let commandHistory = [];
        let historyIndex = -1;
        
        // Initialize universal graphics rendering system
        window.rexxjs = {
            autoRenderMode: true,                  // Auto-render plots by default
            suggestedRenderFunction: null,         // Function suggestions from graphics libs
            renderTarget: 'auto',                  // Let RENDER choose DOM target
            
            // Configuration methods
            setAutoRender: (enabled) => { window.rexxjs.autoRenderMode = enabled; },
            setRenderTarget: (selector) => { window.rexxjs.renderTarget = selector; },
            
            // Manual render trigger
            renderSuggested: () => {
                if (window.rexxjs.suggestedRenderFunction) {
                    try {
                        const result = window.rexxjs.suggestedRenderFunction();
                        if (result) {
                            addToHistory(`üìä Plot rendered manually`, 'repl-output');
                        }
                    } catch (error) {
                        addToHistory(`‚ùå Render failed: ${error.message}`, 'repl-error');
                    }
                }
            }
        };
        
        // Demo REXX scripts showcasing various features
        const demoScripts = {
            basic: `
                    SAY "=== REXX Demo ==="

                    // Variables and string interpolation
                    LET name = "World"
                    LET message = "Hello " || name || "!"
                    SAY message

                    // Math expressions
                    LET x = 10
                    LET y = 5
                    LET result = x * y + 2
                    SAY "Math result: " || result
                    
                    // JSON parsing and object properties
                    LET jsonData = '{"user": "Alice", "score": 95, "active": true}'
                    LET parsed = JSON_PARSE string=jsonData
                    SAY "User: " || parsed.user || ", Score: " || parsed.score
                    
                    // URL parsing
                    LET url = "https://api.example.com:8080/users?page=1"
                    LET urlParts = URL_PARSE url=url
                    SAY "Host: " || urlParts.hostname || ", Port: " || urlParts.port
                    
                    // Simple conditional check
                    SAY "Score evaluation: " || parsed.score || " points"
                    
                    SAY "=== Demo Complete ==="
        `.trim(),
            
            require: `
                    SAY "=== Library Loading Demo ==="
                    
                    // Load a graphics library
                    SAY "Loading R-inspired graphics library..."
                    REQUIRE "org.rexxjs/r-graphics-functions"
                    
                    // Create some sample data
                    LET dataJson = "[1, 4, 2, 8, 5, 7, 3, 9, 6, 4]"
                    LET data = JSON_PARSE text=dataJson
                    SAY "Sample data: " || dataJson
                    
                    // Calculate basic statistics
                    LET mean = MEAN data=data
                    LET max_val = MAX data=data
                    LET min_val = MIN data=data
                    
                    SAY "Mean: " || mean
                    SAY "Max: " || max_val
                    SAY "Min: " || min_val
                    
                    // Library loading demonstration complete
                    SAY "‚úÖ Library functions now available for use!"
                    SAY "=== Demo Complete ==="
        `.trim(),
            
            histogram: `
                    SAY "=== R Histogram Visualization Demo ==="
                    
                    // Load the R graphics library
                    SAY "Loading R-inspired graphics library..."
                    REQUIRE "org.rexxjs/r-graphics-functions"
                    
                    // Create histogram data
                    LET dataJson = "[1, 2, 2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 6]"
                    LET data = JSON_PARSE text=dataJson
                    SAY "Dataset: " || dataJson
                    
                    // Generate histogram
                    SAY "Creating histogram with 5 bins..."
                    LET histogram = HIST data=data breaks=5 main="Sample Data Distribution" col="steelblue"
                    
                    // Display histogram info
                    SAY "Histogram type: " || histogram.type
                    SAY "Bins: " || histogram.breaks.length
                    
                    // The histogram will auto-render if graphics mode is enabled
                    SAY "üìä Histogram created! Check graphics panel above."
                    SAY "=== Demo Complete ==="
        `.trim()
        };
        
        function updateStatus(message, type = 'loading') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        async function loadRexx() {
            try {
                // Check if we're using bundled version (RexxInterpreter already available)
                // or unbundled version (need to use RexxWebLoader)
                if (typeof RexxInterpreter !== 'undefined') {
                    // Bundled version - RexxInterpreter is already loaded
                    updateStatus('Initializing REXX Interpreter...');
                    replHistory.innerHTML = '<div class="repl-output">Initializing bundled interpreter...</div>';
                } else if (typeof RexxWebLoader !== 'undefined') {
                    // Unbundled version - use the loader
                    updateStatus('Loading REXX Interpreter dependencies...');
                    replHistory.innerHTML = '<div class="repl-output">Loading dependencies...</div>';
                    
                    // Determine basePath based on current location
                    // For local dev at /core/src/repl/ use '../'
                    // For production at /repl/unbundled/ use '/'
                    const currentPath = window.location.pathname;
                    const basePath = currentPath.includes('/unbundled/') ? '/' : '../';
                    
                    await RexxWebLoader.load({
                        basePath: basePath,
                        verbose: false  // Mute verbose loading messages
                        // No onProgress callback to avoid cluttering REPL
                    });
                } else {
                    throw new Error('Neither RexxInterpreter nor RexxWebLoader found. Check script loading.');
                }
                
                // Verify interpreter is available
                if (typeof RexxInterpreter === 'undefined') {
                    throw new Error('RexxInterpreter not available after loading.');
                }
                
                updateStatus('‚úÖ REXX Interpreter loaded successfully!', 'success');
                demoSelect.disabled = false;
                runDemoBtn.disabled = false;
                showDemoBtn.disabled = false;
                
                // Initialize REPL
                replHistory.innerHTML = ''; // Clear loading message
                addToHistory('REXX REPL ready! Type REXX commands and press Enter.', 'repl-welcome');
                addToHistory('Use ‚Üë/‚Üì arrows for command history. Use REQUIRE to load libraries.', 'repl-welcome');
                addToHistory('Library Example: REQUIRE "org.rexxjs/graphviz-functions"', 'repl-welcome');
                addToHistory('Try: SAY "Hello, REXX!" or explore library functions.', 'repl-welcome');
                replInputContainer.style.display = 'flex';
                replInput.focus();
                scrollToBottom();
                
            } catch (error) {
                updateStatus(`‚ùå Failed to load: ${error.message}`, 'error');
                addToHistory(`‚ùå Load failed: ${error.message}`, 'repl-error');
                console.error('Load error:', error);
            }
        }
        
        async function runSelectedDemo() {
            const selectedDemo = demoSelect.value;
            if (!selectedDemo) {
                addToHistory('‚ùå Please select a demo first', 'repl-error');
                return;
            }
            await runDemo(selectedDemo);
        }
        
        function showSelectedDemo() {
            const selectedDemo = demoSelect.value;
            if (!selectedDemo) {
                addToHistory('‚ùå Please select a demo first', 'repl-error');
                return;
            }
            showDemo(selectedDemo);
        }
        
        async function runDemo(demoType = 'basic') {
            try {
                addToHistory('üöÄ Running REXX Demo - Watch each command execute step by step!', 'repl-output');
                addToHistory('', 'repl-output'); // Add blank line for spacing
                
                // Create interpreter instance
                const demoInterpreter = new RexxInterpreter(null, {
                    output: (text) => {
                        addToHistory(`   ‚Üí ${text}`, 'repl-output'); // Indent output
                    }
                });
                
                // Get the selected demo script
                const selectedScript = demoScripts[demoType];
                if (!selectedScript) {
                    addToHistory(`‚ùå Demo "${demoType}" not found`, 'repl-error');
                    return;
                }
                
                // Split demo script into individual lines
                const lines = selectedScript.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('//'));
                
                // Execute each line with a delay, showing command before execution
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Show the command about to be executed
                    addToHistory(`rexx> ${line}`, 'repl-command');
                    
                    // Quick delay for readability 
                    await new Promise(resolve => setTimeout(resolve, 600));
                    
                    try {
                        // Parse and execute just this line
                        const commands = parse(line);
                        await demoInterpreter.run(commands);
                    } catch (lineError) {
                        addToHistory(`   ‚ùå Error: ${lineError.message}`, 'repl-error');
                    }
                    
                    // Add separator between commands except for the last one
                    if (i < lines.length - 1) {
                        addToHistory('', 'repl-output'); // Blank line separator
                    }
                    
                    // Short pause between commands
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                addToHistory('', 'repl-output'); // Add blank line before completion
                addToHistory('‚úÖ Demo completed! Now you can try your own REXX commands below.', 'repl-output');
                
            } catch (error) {
                addToHistory(`‚ùå Demo failed: ${error.message}`, 'repl-error');
                console.error('Demo error:', error);
            }
        }
        
        function showDemo(demoType = 'basic') {
            const selectedScript = demoScripts[demoType];
            if (!selectedScript) {
                addToHistory(`‚ùå Demo "${demoType}" not found`, 'repl-error');
                return;
            }
            
            const demoNames = {
                basic: 'Basic REXX Features',
                require: 'Library Loading (REQUIRE)',
                histogram: 'R Histogram Visualization'
            };
            
            addToHistory(`--- ${demoNames[demoType]} Demo Source Code ---`, 'repl-output');
            
            // Display the script with syntax highlighting-style formatting
            const lines = selectedScript.split('\n');
            const formattedScript = lines.map((line, index) => {
                const lineNum = String(index + 1).padStart(2, ' ');
                return `${lineNum}: ${line}`;
            }).join('\n');
            
            // Use a dedicated class for code display
            const codeDiv = document.createElement('div');
            codeDiv.className = 'repl-code-display';
            codeDiv.style.cssText = `
                background: #2d2d2d;
                color: #f8f8f2;
                font-family: 'Courier New', monospace;
                font-size: 0.9em;
                padding: 15px;
                border-radius: 5px;
                border: 1px solid #555;
                white-space: pre;
                overflow-x: auto;
                margin: 5px 0 10px 0;
                line-height: 1.4;
            `;
            codeDiv.textContent = formattedScript;
            
            replHistory.appendChild(codeDiv);
            scrollToBottom();
            
            addToHistory(`üìã Demo script displayed (${lines.length} lines)`, 'repl-output');
        }
        
        function addToHistory(content, className, canvasElement = null) {
            const div = document.createElement('div');
            div.className = className;
            
            if (canvasElement) {
                // For graphics output
                div.appendChild(canvasElement);
                const info = document.createElement('div');
                info.className = 'graphics-info';
                info.textContent = content;
                div.appendChild(info);
            } else {
                // For text output
                div.textContent = content;
            }
            
            replHistory.appendChild(div);
            scrollToBottom();
        }
        
        function createGraphicsContainer(containerId = null) {
            // Create unique container ID if not provided
            if (!containerId) {
                containerId = 'repl-graphics-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            }
            
            const graphicsDiv = document.createElement('div');
            graphicsDiv.id = containerId;
            graphicsDiv.className = 'repl-graphics';
            
            replHistory.appendChild(graphicsDiv);
            scrollToBottom();
            
            return graphicsDiv;
        }
        
        function addGraphicsInfo(message, type = 'success') {
            const color = type === 'error' ? '#f48771' : '#4ec9b0';
            addToHistory(message, 'repl-output');
        }
        
        function scrollToBottom() {
            // Scroll the container to bottom to keep command line in view
            const container = document.querySelector('.repl-container');
            container.scrollTop = container.scrollHeight;
        }
        
        async function executeCommand(command) {
            if (!command.trim()) return;
            
            // Add command to history
            commandHistory.push(command);
            historyIndex = -1;
            
            // Display command
            addToHistory(`rexx> ${command}`, 'repl-command');
            
            try {
                // Clear previous render suggestions
                window.rexxjs.suggestedRenderFunction = null;
                
                // Create or reuse interpreter instance
                if (!interpreter) {
                    interpreter = new RexxInterpreter(null, {
                        output: (text) => {
                            addToHistory(text, 'repl-output');
                        }
                    });
                }
                
                const commands = parse(command);
                await interpreter.run(commands);
                
                // Check for render suggestions after command execution
                if (window.rexxjs.suggestedRenderFunction) {
                    if (window.rexxjs.autoRenderMode) {
                        try {
                            // Auto-render the suggested plot
                            const renderResult = window.rexxjs.suggestedRenderFunction();
                            
                            if (typeof renderResult === 'string') {
                                // If it's a DOM selector or element ID, find and display it
                                const element = document.getElementById(renderResult) || document.querySelector(renderResult);
                                if (element) {
                                    addGraphicsInfo(`üìä Plot auto-rendered to ${renderResult}`);
                                } else {
                                    addGraphicsInfo(`üìä Plot rendered (output: ${renderResult})`);
                                }
                            } else {
                                addGraphicsInfo(`üìä Plot auto-rendered successfully`);
                            }
                        } catch (renderError) {
                            addGraphicsInfo(`‚ùå Auto-render failed: ${renderError.message}`, 'error');
                        }
                    } else {
                        // Just notify that render is available
                        addGraphicsInfo(`üìä Plot ready for rendering (auto-render disabled). Use window.rexxjs.renderSuggested() to render manually.`);
                    }
                }
                
                // Update manual render button state
                updateManualRenderButton();
                
            } catch (error) {
                addToHistory(`Error: ${error.message}`, 'repl-error');
                console.error('REPL error:', error);
            }
            
            // Ensure command line stays in view after execution
            scrollToBottom();
        }
        
        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                const command = replInput.value;
                replInput.value = '';
                executeCommand(command);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (commandHistory.length > 0) {
                    if (historyIndex === -1) {
                        historyIndex = commandHistory.length - 1;
                    } else if (historyIndex > 0) {
                        historyIndex--;
                    }
                    replInput.value = commandHistory[historyIndex] || '';
                }
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (historyIndex !== -1) {
                    if (historyIndex < commandHistory.length - 1) {
                        historyIndex++;
                        replInput.value = commandHistory[historyIndex] || '';
                    } else {
                        historyIndex = -1;
                        replInput.value = '';
                    }
                }
            }
        }
        
        function clearOutput() {
            replHistory.innerHTML = '<div class="repl-welcome">REPL cleared</div>';
            commandHistory = [];
            historyIndex = -1;
            if (replInputContainer.style.display === 'flex') {
                replInput.focus();
                scrollToBottom();
            }
        }
        
        function manualRender() {
            if (window.rexxjs && window.rexxjs.suggestedRenderFunction) {
                window.rexxjs.renderSuggested();
            } else {
                addToHistory('No plot available to render', 'repl-error');
            }
        }
        
        function updateManualRenderButton() {
            const manualBtn = document.getElementById('manual-render-btn');
            if (window.rexxjs && window.rexxjs.suggestedRenderFunction) {
                manualBtn.disabled = false;
                manualBtn.style.opacity = '1';
            } else {
                manualBtn.disabled = true;
                manualBtn.style.opacity = '0.6';
            }
        }
        
        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            replInput.addEventListener('keydown', handleKeyDown);
            
            // Auto-render checkbox handler
            const autoRenderCheckbox = document.getElementById('auto-render-checkbox');
            // Initialize checkbox state to match window.rexxjs.autoRenderMode
            autoRenderCheckbox.checked = window.rexxjs.autoRenderMode;
            
            autoRenderCheckbox.addEventListener('change', function() {
                window.rexxjs.setAutoRender(this.checked);
                const status = this.checked ? 'enabled' : 'disabled';
                addToHistory(`Auto-rendering ${status}`, 'repl-output');
            });
            
            // Initialize manual render button state
            updateManualRenderButton();
            
            // Keep focus on input when clicking in the REPL area (but not when selecting text)
            document.querySelector('.repl-container').addEventListener('click', function(event) {
                if (replInputContainer.style.display === 'flex') {
                    // Only focus if user isn't selecting text
                    const selection = window.getSelection();
                    if (selection.toString().length === 0) {
                        replInput.focus();
                        scrollToBottom();
                    }
                }
            });
        });
    </script>
</body>
</html>