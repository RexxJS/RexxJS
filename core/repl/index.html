<!DOCTYPE html>
<html>
<head>
    <title>REXX Web REPL</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .code { background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .loading { background: #fff3cd; border: 1px solid #ffeaa7; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .repl-container { 
            background: #1e1e1e; 
            color: #d4d4d4; 
            font-family: 'Courier New', monospace; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px 0; 
            min-height: 400px; 
            max-height: 600px; 
            overflow-y: auto; 
        }
        
        .repl-history { 
            margin-bottom: 10px; 
            user-select: text; /* Allow text selection in history */
        }
        
        .repl-welcome { 
            color: #6a9955; 
            margin: 2px 0; 
        }
        
        .repl-input-line { 
            display: flex; 
            align-items: center; 
            margin-top: 5px; 
        }
        
        .repl-prompt { 
            color: #4ec9b0; 
            font-weight: bold; 
            margin-right: 8px; 
            user-select: none; 
        }
        
        .repl-input { 
            background: transparent; 
            border: none; 
            color: #d4d4d4; 
            font-family: inherit; 
            font-size: inherit; 
            outline: none; 
            flex: 1; 
            caret-color: #d4d4d4; 
        }
        
        .repl-command { 
            color: #d4d4d4; 
            margin: 2px 0; 
            user-select: text; 
        }
        
        .repl-output { 
            color: #ce9178; 
            margin: 2px 0 8px 20px; 
            white-space: pre-wrap; 
            user-select: text; 
        }
        
        .repl-error { 
            color: #f48771; 
            margin: 2px 0 8px 20px; 
            white-space: pre-wrap; 
            user-select: text; 
        }
        
        .repl-graphics {
            margin: 10px 0 10px 20px;
        }
        
        .repl-graphics canvas {
            border: 1px solid #555;
            border-radius: 4px;
            background: white;
            display: block;
        }
        
        .repl-graphics .graphics-info {
            color: #4ec9b0;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>REXX Web REPL</h1>
    
    <p>This interactive REXX REPL (Read-Eval-Print Loop) lets you execute REXX code directly in your browser using the REXX Web Loader.</p>
    
    <h2>REXX REPL</h2>
    
    <div id="status" class="status loading">Click "Load REXX" to start</div>
    
    <button onclick="loadRexx()">Load REXX Interpreter</button>
    <button onclick="runDemo()" id="run-btn" disabled>Run Demo Script</button>
    <button onclick="showDemo()" id="show-btn" disabled>Show Demo Script</button>
    <button onclick="clearOutput()">Clear Output</button>
    
    <div class="repl-container">
        <div id="repl-history" class="repl-history">
            <div class="repl-welcome">Click "Load REXX Interpreter" to begin...</div>
        </div>
        <div class="repl-input-line" id="repl-input-container" style="display: none;">
            <span class="repl-prompt">rexx> </span>
            <input type="text" id="repl-input" class="repl-input" autocomplete="off" spellcheck="false">
        </div>
    </div>
    
    <!-- Load only the web loader -->
    <script src="../src/interpreter-web-loader.js"></script>
    <!-- Load browser-compatible R graphics renderer -->
    <script src="../../extras/functions/r-inspired/graphics/histogram-browser-renderer.js"></script>
    
    <script>
        const statusDiv = document.getElementById('status');
        const runBtn = document.getElementById('run-btn');
        const showBtn = document.getElementById('show-btn');
        const replHistory = document.getElementById('repl-history');
        const replInputContainer = document.getElementById('repl-input-container');
        const replInput = document.getElementById('repl-input');
        
        let interpreter = null;
        let commandHistory = [];
        let historyIndex = -1;
        
        // Demo REXX script showcasing various features
        const demoScript = `
                    SAY "=== REXX Web Loader Demo ==="

                    // Variables and string interpolation
                    LET name = "World"
                    LET message = "Hello " || name || "!"
                    SAY message

                    // Math expressions
                    LET x = 10
                    LET y = 5
                    LET result = x * y + 2
                    SAY "Math result: " || result
                    
                    // JSON parsing and object properties
                    LET jsonData = '{"user": "Alice", "score": 95, "active": true}'
                    LET parsed = JSON_PARSE string=jsonData
                    SAY "User: " || parsed.user || ", Score: " || parsed.score
                    
                    // URL parsing
                    LET url = "https://api.example.com:8080/users?page=1"
                    LET urlParts = URL_PARSE url=url
                    SAY "Host: " || urlParts.hostname || ", Port: " || urlParts.port
                    
                    // Control flow
                    IF parsed.score > 90 THEN
                        SAY "Excellent score!"
                    ELSE
                        SAY "Good effort!"
                    ENDIF
                    
                    SAY "=== Demo Complete ==="
        `.trim();
        
        function updateStatus(message, type = 'loading') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        async function loadRexx() {
            try {
                updateStatus('Loading REXX Interpreter dependencies...');
                replHistory.innerHTML = '<div class="repl-output">Loading dependencies...</div>';
                
                await RexxWebLoader.load({
                    basePath: '../src/',
                    verbose: false  // Mute verbose loading messages
                    // No onProgress callback to avoid cluttering REPL
                });
                
                updateStatus('✅ REXX Interpreter loaded successfully!', 'success');
                runBtn.disabled = false;
                showBtn.disabled = false;
                
                // Initialize REPL
                replHistory.innerHTML = ''; // Clear loading message
                addToHistory('REXX REPL ready! Type REXX commands and press Enter.', 'repl-welcome');
                addToHistory('Use ↑/↓ arrows for command history. Use REQUIRE to load libraries.', 'repl-welcome');
                addToHistory('Example: REQUIRE "../../extras/functions/r-inspired/graphics/graphics-functions.js"', 'repl-welcome');
                addToHistory('With prefix: REQUIRE "../../extras/functions/r-inspired/graphics/graphics-functions.js" AS "math_"', 'repl-welcome');
                addToHistory('With regex: REQUIRE "../../extras/functions/r-inspired/graphics/graphics-functions.js" AS "gfx_(.*)"', 'repl-welcome');
                replInputContainer.style.display = 'flex';
                replInput.focus();
                scrollToBottom();
                
            } catch (error) {
                updateStatus(`❌ Failed to load: ${error.message}`, 'error');
                addToHistory(`❌ Load failed: ${error.message}`, 'repl-error');
                console.error('Load error:', error);
            }
        }
        
        async function runDemo() {
            try {
                addToHistory('--- Running REXX Demo ---', 'repl-output');
                
                // Create interpreter instance
                const demoInterpreter = new RexxInterpreter(null, {
                    output: (text) => {
                        addToHistory(text, 'repl-output');
                    }
                });
                
                const commands = parse(demoScript);
                await demoInterpreter.run(commands);
                
                addToHistory('✅ Demo completed successfully!', 'repl-output');
                
            } catch (error) {
                addToHistory(`❌ Demo failed: ${error.message}`, 'repl-error');
                console.error('Demo error:', error);
            }
        }
        
        function showDemo() {
            addToHistory('--- Demo Script Source Code ---', 'repl-output');
            
            // Display the script with syntax highlighting-style formatting
            const lines = demoScript.split('\n');
            const formattedScript = lines.map((line, index) => {
                const lineNum = String(index + 1).padStart(2, ' ');
                return `${lineNum}: ${line}`;
            }).join('\n');
            
            // Use a dedicated class for code display
            const codeDiv = document.createElement('div');
            codeDiv.className = 'repl-code-display';
            codeDiv.style.cssText = `
                background: #2d2d2d;
                color: #f8f8f2;
                font-family: 'Courier New', monospace;
                font-size: 0.9em;
                padding: 15px;
                border-radius: 5px;
                border: 1px solid #555;
                white-space: pre;
                overflow-x: auto;
                margin: 5px 0 10px 0;
                line-height: 1.4;
            `;
            codeDiv.textContent = formattedScript;
            
            replHistory.appendChild(codeDiv);
            scrollToBottom();
            
            addToHistory(`📋 Demo script displayed (${lines.length} lines)`, 'repl-output');
        }
        
        function addToHistory(content, className, canvasElement = null) {
            const div = document.createElement('div');
            div.className = className;
            
            if (canvasElement) {
                // For graphics output
                div.appendChild(canvasElement);
                const info = document.createElement('div');
                info.className = 'graphics-info';
                info.textContent = content;
                div.appendChild(info);
            } else {
                // For text output
                div.textContent = content;
            }
            
            replHistory.appendChild(div);
            scrollToBottom();
        }
        
        function addGraphicsToHistory(plotData, title) {
            // Create a unique canvas element
            const canvasId = 'repl-canvas-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            const canvas = document.createElement('canvas');
            canvas.id = canvasId;
            canvas.width = 400;
            canvas.height = 300;
            
            const graphicsDiv = document.createElement('div');
            graphicsDiv.className = 'repl-graphics';
            graphicsDiv.appendChild(canvas);
            
            const info = document.createElement('div');
            info.className = 'graphics-info';
            info.textContent = title || `${plotData.type} plot generated`;
            graphicsDiv.appendChild(info);
            
            replHistory.appendChild(graphicsDiv);
            
            // Render the plot to the canvas
            try {
                renderPlotToCanvas(plotData, canvasId);
            } catch (error) {
                info.textContent = `Graphics error: ${error.message}`;
                info.style.color = '#f48771';
            }
            
            scrollToBottom();
        }
        
        function scrollToBottom() {
            // Scroll the container to bottom to keep command line in view
            const container = document.querySelector('.repl-container');
            container.scrollTop = container.scrollHeight;
        }
        
        async function executeCommand(command) {
            if (!command.trim()) return;
            
            // Add command to history
            commandHistory.push(command);
            historyIndex = -1;
            
            // Display command
            addToHistory(`rexx> ${command}`, 'repl-command');
            
            try {
                // Create or reuse interpreter instance
                if (!interpreter) {
                    interpreter = new RexxInterpreter(null, {
                        output: (text) => {
                            addToHistory(text, 'repl-output');
                        }
                    });
                }
                
                const commands = parse(command);
                await interpreter.run(commands);
                
            } catch (error) {
                addToHistory(`Error: ${error.message}`, 'repl-error');
                console.error('REPL error:', error);
            }
            
            // Ensure command line stays in view after execution
            scrollToBottom();
        }
        
        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                const command = replInput.value;
                replInput.value = '';
                executeCommand(command);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (commandHistory.length > 0) {
                    if (historyIndex === -1) {
                        historyIndex = commandHistory.length - 1;
                    } else if (historyIndex > 0) {
                        historyIndex--;
                    }
                    replInput.value = commandHistory[historyIndex] || '';
                }
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (historyIndex !== -1) {
                    if (historyIndex < commandHistory.length - 1) {
                        historyIndex++;
                        replInput.value = commandHistory[historyIndex] || '';
                    } else {
                        historyIndex = -1;
                        replInput.value = '';
                    }
                }
            }
        }
        
        function clearOutput() {
            replHistory.innerHTML = '<div class="repl-welcome">REPL cleared</div>';
            commandHistory = [];
            historyIndex = -1;
            if (replInputContainer.style.display === 'flex') {
                replInput.focus();
                scrollToBottom();
            }
        }
        
        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            replInput.addEventListener('keydown', handleKeyDown);
            
            // Listen for SHOW command graphics events
            window.addEventListener('rexx-graphics', function(event) {
                const plotData = event.detail.plotData;
                const command = event.detail.command;
                addGraphicsToHistory(plotData, `${command}: ${plotData.type} plot`);
            });
            
            // Keep focus on input when clicking in the REPL area (but not when selecting text)
            document.querySelector('.repl-container').addEventListener('click', function(event) {
                if (replInputContainer.style.display === 'flex') {
                    // Only focus if user isn't selecting text
                    const selection = window.getSelection();
                    if (selection.toString().length === 0) {
                        replInput.focus();
                        scrollToBottom();
                    }
                }
            });
        });
    </script>
</body>
</html>